@using DMS.Application.Interfaces.Setup.ApplicantsRepository
@using DMS.Application.Interfaces.Setup.ModuleRepository
@using DMS.Application.Interfaces.Setup.RoleRepository
@using DMS.Application.Interfaces.Setup.UserRepository
@using DMS.Application.Services;
@using DMS.Domain.Enums
@using DMS.Web.Controllers.Services
@using System.Security.Claims
@inject IModuleRepository _moduleRepo;
@inject IUserRepository _userRepo;
@inject IRoleAccessRepository _roleRepo;
@inject IApplicantsPersonalInformationRepository _applicantsPersonalInformationRepo;
@inject IStringLocalizer<SharedResources> localizer
@inject IFtpDownloaderService _ftpDownloaderService
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment WebHostEnvironment;

@{
    int userId = int.Parse(User.Identity.Name);
    var userInfo = await _userRepo.GetUserAsync(userId);
    string userProfile = Url.Content("~/images/user/default.png");

    string[] exclusions = { "Dashboard", "Navigation", "Applicants" };
    string[] btmPaddingRemoval = { "Admin Panel" };

    if (userInfo is not null && !string.IsNullOrWhiteSpace(userInfo.ProfilePicture))
        if (System.IO.File.Exists(System.IO.Path.Combine(WebHostEnvironment.WebRootPath, userInfo.ProfilePicture[1..].Replace("/", "\\"))))
            userProfile = Url.Content("~" + userInfo.ProfilePicture);

    var modules = await _roleRepo.GetByUserId(userId);
    var moduleGroups = modules.Where(m => m.CanRead && m.ModuleTypeIsVisible && !m.ModuleTypeIsDisabled).OrderBy(m => m.ModuleTypeOrder).Select(m => new { m.ModuleType, m.ModuleTypeIcon, m.ModuleTypeController, m.ModuleTypeAction }).Distinct();
    var parentModules = modules.Where(m => m.CanRead && m.IsVisible && !m.IsDisabled && m.ParentModuleId == 0).OrderBy(m => m.ModuleOrdinal).Distinct();
    var subModules = modules.Where(m => m.CanRead && m.IsVisible && !m.IsDisabled && m.ParentModuleId != 0).OrderBy(m => m.ModuleOrdinal).Distinct();
}

@if (User.Identity.IsAuthenticated)
{
    <div class="leftside-menu rounded-4 overflow-hidden">

        <!-- Brand Logo Light -->
        <a asp-controller="Home" asp-action="Index" class="logo logo-light">
            <span class="logo-lg">
                <img src="~/images/JuanTahananAssets/Logo/JuanTahananLogo.png" alt="logo" style="height:40px;">
            </span>
            <span class="logo-sm">
                <img src="~/images/companylogo/mnl_logo_light.png" alt="small logo">
            </span>
        </a>

        <!-- Brand Logo Dark -->
        <a asp-controller="Home" asp-action="Index" class="logo logo-dark">
            <span class="logo-lg">
                <img src="~/images/JuanTahananAssets/Logo/JuanTahananLogo.png" alt="dark logo" style="height:40px;">
            </span>
            <span class="logo-sm">
                <img src="~/images/companylogo/mnl_logo_dark.png" alt="small logo">
            </span>
        </a>

        <!-- Full Sidebar Menu Close Button -->
        <div class="button-close-fullsidebar">
            <i class="ri-close-fill align-middle"></i>
        </div>

        <!-- Sidebar -->
        <div class="h-100" id="leftside-menu-container" data-simplebar>

            <!--- Sidemenu -->
            <ul class="side-nav">
                <li class="side-nav-item d-flex align-items-center justify-content-center">
                    <div class="side-profile mb-3">
                        <div class="auth-avatar text-center">
                            <img src="@Url.Content("~" + userProfile)" alt="A" class="img-fluid rounded-circle mx-auto avatar-xxxl img-thumbnail user-profile" id="userProfile">
                            <div class="mx-auto d-none" style="width: 140px; height: 140px; font-size: 50px;"><span class="auth-initial-avatar avatar-title fw-bold text-white rounded-circle" style="background-color: #000;">A</span></div>
                        </div>
                        <h4 class="mt-3 mb-0 text-dark fw-bold text-center">@ViewData["Name"]</h4>
                        <small class="d-block text-truncate text-center text-dark fw-semibold">@ViewData["Position"]</small>
                    </div>
                </li>
                @if (userInfo.UserRoleId == (int)PredefinedRoleType.Beneficiary)
                {
                    <li class="side-nav-item mb-2 d-flex align-items-center justify-content-center">
                        @{
                            //var beneficiaryApplicationData = applicationData.Where(item => item.UserId == userId && activeStatus.Contains(item.));
                            Dictionary<string, string> btnParameters = new()
                            {
                                { "text", "Continue Loan Application" },
                                { "link", $"/Applicants/HousingLoanForm/{userInfo.PagibigNumber}" },
                                { "color", "primary" },
                                { "icon", "mdi-clipboard-plus-outline" }
                            };

                            // Beneficiary
                            int[] inactiveStatus = { 2, 5, 9, 10 };

                            var applicationData = await _applicantsPersonalInformationRepo.GetCurrentApplicationByUser(userId);

                            // Runs if data is not null and status is active (warning button)
                            if (applicationData is not null && !inactiveStatus.Contains(applicationData.ApprovalStatus.Value))
                            {
                                btnParameters["text"] = "View my application";
                                btnParameters["link"] = $"/Applicants/Details/{applicationData.Code}";
                                btnParameters["color"] = "warning";
                                btnParameters["icon"] = "mdi-clipboard-edit-outline";
                            }

                            // check if url is the same as the current one
                            var urlCheck = Context.Request.Path == btnParameters["link"];

                            <button class="btn-application align-items-center btn btn-@btnParameters["color"]" onclick="location.href='@btnParameters["link"]'" style="border-radius: 8px!important;">
                                <span class="text-btn-application text-wrap">@btnParameters["text"]</span>
                            </button>
                        }
                     </li>
                }

                @*<li class="side-nav-title">@localizer["Navigation"]</li>*@
                @foreach (var moduleGroup in moduleGroups)
                {
                    var _parentModules = parentModules.Where(m => m.ModuleType == moduleGroup.ModuleType);

                    // @if (exclusions.Contains(moduleGroup.ModuleType))
                    // {
                    //     continue;
                    // }

                    @if (_parentModules.Any())
                    {
                        var hideClass = exclusions.Contains(moduleGroup.ModuleType) ? "d-none" : "";
                        var btmPadding = btmPaddingRemoval.Contains(moduleGroup.ModuleType) ? "padding-bottom: 0px;" : "";

                        <li class="side-nav-title @(hideClass)" style="@(btmPadding)">
                            @moduleGroup.ModuleType
                        </li>
                    }
                    else
                    {
                        <li class="side-nav-item">
                            <a asp-controller="@moduleGroup.ModuleTypeController" asp-action="@moduleGroup.ModuleTypeAction" class="side-nav-link">
                                @* <i class="@moduleGroup.ModuleTypeIcon"></i> *@
                                @Html.Raw(@moduleGroup.ModuleTypeIcon)
                                <span> @moduleGroup.ModuleType </span>
                            </a>
                        </li>
                    }

                    @foreach (var parentModule in parentModules)
                    {
                        if (parentModule.ModuleType == moduleGroup.ModuleType)
                        {
                            if (parentModule.HasSubModule)
                            {

                                <li class="side-nav-item">
                                    <a href="#sidebar@(parentModule.ModuleId)" data-bs-toggle="collapse" aria-expanded="false" class="side-nav-link">
                                        <i class="@parentModule.ModuleIcon"></i>
                                        <span>@parentModule.ModuleName</span>
                                        <span class="menu-arrow"></span>
                                    </a>
                                    <div class="collapse" id="sidebar@(parentModule.ModuleId)">
                                        <ul class="side-nav-second-level">
                                            @foreach (var subModule in subModules)
                                            {
                                                if (subModule.ParentModuleId == parentModule.ModuleId)
                                                {
                                                    <li>
                                                        <a asp-controller="@subModule.ModuleController" asp-action="@subModule.ModuleAction">@subModule.ModuleName</a>
                                                    </li>
                                                }
                                            }
                                        </ul>
                                    </div>
                                </li>
                            }
                            else
                            {
                                <li class="side-nav-item">
                                    <a asp-controller="@parentModule.ModuleController" asp-action="@parentModule.ModuleAction" class="side-nav-link">
                                        @* <i class="@parentModule.ModuleIcon"></i> *@
                                        @Html.Raw(@parentModule.ModuleIcon)
                                        <span> @parentModule.ModuleName </span>
                                    </a>
                                </li>
                            }
                        }
                    }
                }

                <li class="side-nav-item">
                    <a asp-controller="Account" asp-action="LogOff" class="side-nav-link">
                        <i class="mdi mdi-logout"></i>
                        <span> @localizer["Log Out"] </span>
                    </a>
                </li>
            </ul>
            <!--- End Sidemenu -->

            <div class="clearfix"></div>
        </div>
        <!-- End Sidebar -->
    </div>
}
